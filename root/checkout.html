<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Checkout</title>
  <link rel="stylesheet" href="css/style.css">
  <script type="module" src="js/app.js"></script>
</head>
<body>
  <header>
     <img src="assets/images/logo-gm.png" alt="Logo da Loja" class="logo">
    <h1>Checkout</h1>

    <nav>
      <ul class="nav-links">
        <li><a href="index.html">Início</a></li>
        <li><a href="product.html">Produtos</a></li>
        <li><a href="cart.html">Carrinho</a></li>
        <li><a href="checkout.html">Checkout</a></li>
      </ul>
    </nav>
  </header>

  <main>
    <section id="checkout">
      <h2>Finalizar Compra</h2>

      <form id="checkout-form" class="checkout-form">
        <div class="form-group">
          <label for="cep">CEP</label>
          <input type="text" id="cep" maxlength="9" placeholder="00000-000" required>
        </div>

        <div class="form-group">
          <label for="rua">Rua</label>
          <input type="text" id="rua" required>
        </div>

        <div class="form-group">
          <label for="numero">Número</label>
          <input type="number" id="numero" required>
        </div>

        <div class="form-group">
          <label for="bairro">Bairro</label>
          <input type="text" id="bairro" required>
        </div>

        <div class="form-group">
          <label for="cidade">Cidade</label>
          <input type="text" id="cidade" required>
        </div>

        <div class="form-group">
          <label for="uf">Estado</label>
          <input type="text" id="uf" required>
        </div>

        <button type="submit">Finalizar Pedido</button>
      </form>
    </section>
  </main>

  <!-- Feedback -->
  <div id="feedback" class="feedback" style="display:none;"></div>

<script>
  // Função de feedback
  function showFeedback(message, type = "success") {
    const feedback = document.getElementById("feedback");
    feedback.textContent = message;
    feedback.className = `feedback ${type}`;
    feedback.style.display = "block";
    setTimeout(() => feedback.style.display = "none", 3000);
  }

  // Bloquear acesso ao checkout pelo menu se carrinho estiver vazio
  document.addEventListener("DOMContentLoaded", () => {
    const cart = JSON.parse(localStorage.getItem("cart") || "[]");
    const checkoutLink = document.querySelector('.nav-links a[href="checkout.html"]');

    if (!cart || cart.length === 0) {
      // Remove navegação direta
      checkoutLink.addEventListener("click", (e) => {
        e.preventDefault();
        showFeedback("Carrinho vazio! Adicione produtos antes de finalizar.", "error");
      });

      // Se estiver na página checkout.html, redireciona
      if (window.location.pathname.endsWith("checkout.html")) {
        showFeedback("Carrinho vazio! Redirecionando para o início...", "error");
        setTimeout(() => { window.location.href = "index.html"; }, 2500);
      }
    }
  });

  // Validação CEP e preenchimento automático
  document.getElementById("cep").addEventListener("input", async (e) => {
    const cep = e.target.value.replace(/\D/g, "");
    if (cep.length === 8) {
      try {
        const res = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
        const data = await res.json();
        if (data.erro) {
          showFeedback("CEP não encontrado. Preencha manualmente.", "error");
          return;
        }
        document.getElementById("rua").value = data.logradouro || "";
        document.getElementById("bairro").value = data.bairro || "";
        document.getElementById("cidade").value = data.localidade || "";
        document.getElementById("uf").value = data.uf || "";
        document.getElementById("numero").focus();
        showFeedback("Endereço preenchido com sucesso!");
      } catch {
        showFeedback("Erro de conexão. Preencha manualmente.", "error");
      }
    }
  });

  // Validação do formulário de checkout
  document.getElementById("checkout-form").addEventListener("submit", (e) => {
    e.preventDefault();

    const numero = parseInt(document.getElementById("numero").value);
    if (isNaN(numero) || numero <= 0) {
      showFeedback("Número da casa inválido!", "error");
      return;
    }

    // Salvar pedido e limpar carrinho
    localStorage.removeItem("cart");
    showFeedback("Pedido realizado com sucesso!");
    setTimeout(() => { window.location.href = "index.html"; }, 3000);
  });
</script>

</body>
</html>